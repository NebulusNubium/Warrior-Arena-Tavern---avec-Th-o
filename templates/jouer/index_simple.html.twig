{% extends 'base.html.twig' %}

{% block title %}Composer une équipe{% endblock %}

{% block body %}
<img src="{{ asset('bottom.png') }}" alt="Décoration" class="form-page-decoration">

<div class="play-page">
    <h1 class="play-title">Composer votre équipe</h1>
    
    <!-- Plateau de jeu -->
    <div class="battle-board">
        <img src="{{ asset('bagarre.png') }}" alt="Plateau de combat">
        <div class="board-overlay">Arène de Combat</div>
    </div>
    
    <!-- Sélection des personnages -->
    <div class="characters-selection">
        <div class="section-header">
            <h2 class="section-title">Choisissez vos champions</h2>
            <span class="subtitle">Sélectionner 5 champions, ctrl+click pour sélectionner</span>
        </div>
        
        <!-- Grille des personnages -->
        <div class="character-grid" id="character-grid">
            {% for character in characters %}
                <div class="character-card" data-character-id="{{ character.id }}" {% if character.role %}data-role="{{ character.role.name|lower }}"{% endif %}>
                    <div class="selection-indicator"></div>
                    
                    {% if character.imageName %}
                        <img src="{{ asset('uploads/images/' ~ character.imageName) }}" alt="{{ character.name }}" class="character-avatar">
                    {% else %}
                        <div class="character-avatar placeholder">?</div>
                    {% endif %}
                    
                    <h3 class="character-name">{{ character.name }}</h3>
                    
                    <div class="character-role">
                        {% if character.role %}
                            {% set roleClass = character.role.name|lower %}
                            {% if roleClass == 'tank' %}
                                <i class="fa-solid fa-shield-halved role-icon tank"></i>
                            {% elseif roleClass in ['heal', 'healer', 'soigneur'] %}
                                <i class="fa-solid fa-heart role-icon healer"></i>
                            {% else %}
                                <i class="fa-solid fa-burst role-icon dps"></i>
                            {% endif %}
                            <span class="role-name">{{ character.role.name }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="character-quick-stats">
                        <div class="stat">
                            <span class="stat-label">PV</span>
                            <span class="stat-value">{{ character.HP }}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">ATK</span>
                            <span class="stat-value">{{ character.power }}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">DEF</span>
                            <span class="stat-value">{{ character.defense }}</span>
                        </div>
                    </div>
                    
                    <input type="checkbox" name="team[]" value="{{ character.id }}" class="character-checkbox" style="display:none;">
                </div>
            {% endfor %}
        </div>
        
        <!-- Bouton de jeu -->
        <form method="POST" id="team-form">
            <div class="team-controls">
                <div class="team-info">
                    <span class="team-counter">Équipe: <span id="team-count">0</span>/5</span>
                </div>
                <button type="submit" id="play-btn" class="play-button" disabled>
                    <i class="fas fa-play"></i> Commencer le Combat !
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modale des détails du personnage -->
<div id="character-modal" class="character-modal">
    <div class="modal-content">
        <button class="modal-close" id="modal-close">×</button>
        
        <div class="modal-header">
            <img id="modal-avatar" class="modal-avatar" src="" alt="">
            <div class="modal-basic-info">
                <h2 id="modal-name" class="modal-character-name"></h2>
                <div id="modal-role" class="modal-character-role"></div>
            </div>
        </div>
        
        <div class="modal-stats">
            <div class="stat-item">
                <span id="modal-hp" class="stat-value"></span>
                <span class="stat-label">Points de Vie</span>
            </div>
            <div class="stat-item">
                <span id="modal-power" class="stat-value"></span>
                <span class="stat-label">Puissance</span>
            </div>
            <div class="stat-item">
                <span id="modal-defense" class="stat-value"></span>
                <span class="stat-label">Défense</span>
            </div>
        </div>
        <div class="modal-description">
            <h4>Description</h4>
            <p id="modal-description-text"></p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const characterCards = document.querySelectorAll('.character-card');
    const checkboxes = document.querySelectorAll('.character-checkbox');
    const playBtn = document.getElementById('play-btn');
    const teamCountEl = document.getElementById('team-count');
    const modal = document.getElementById('character-modal');
    const modalClose = document.getElementById('modal-close');
    
    // Données des personnages pour la modale
    const charactersData = {
        {% for character in characters %}
        {{ character.id }}: {
            name: "{{ character.name }}",
            hp: {{ character.HP }},
            power: {{ character.power }},
            defense: {{ character.defense }},
            description: "{{ character.description|escape('js') }}",
            imageName: "{{ character.imageName }}",
            role: {% if character.role %}"{{ character.role.name }}"{% else %}null{% endif %}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    function updateTeamCounter() {
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        teamCountEl.textContent = selectedCount;
        playBtn.disabled = selectedCount !== 5;
        
        // Mettre à jour l'apparence des cartes
        characterCards.forEach((card, idx) => {
            if (checkboxes[idx].checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }

    // Gestion simple de la sélection et de la modale
    characterCards.forEach((card, idx) => {
        card.addEventListener('click', function(e) {
            // Empêcher le déclenchement multiple si on clique sur la checkbox
            if (e.target.tagName.toLowerCase() === 'input') return;
            
            // Si on maintient Ctrl/Cmd ou on clique sur l'indicateur de sélection, on sélectionne
            if (e.ctrlKey || e.metaKey || e.target.classList.contains('selection-indicator')) {
                // Limiter à 5 sélections maximum
                const currentlySelected = Array.from(checkboxes).filter(cb => cb.checked).length;
                if (!checkboxes[idx].checked && currentlySelected >= 5) {
                    alert('Vous ne pouvez sélectionner que 5 personnages maximum !');
                    return;
                }
                
                checkboxes[idx].checked = !checkboxes[idx].checked;
                updateTeamCounter();
                return;
            }
            
            // Sinon, on ouvre la modale
            const characterId = card.dataset.characterId;
            const character = charactersData[characterId];
            
            // Remplir la modale avec les données
            document.getElementById('modal-name').textContent = character.name;
            document.getElementById('modal-hp').textContent = character.hp;
            document.getElementById('modal-power').textContent = character.power;
            document.getElementById('modal-defense').textContent = character.defense;
            document.getElementById('modal-description-text').textContent = character.description || "Aucune description disponible.";
            
            // Image
            const modalAvatar = document.getElementById('modal-avatar');
            if (character.imageName) {
                modalAvatar.src = "{{ asset('uploads/images/') }}" + character.imageName;
                modalAvatar.alt = character.name;
                modalAvatar.style.display = 'block';
            } else {
                modalAvatar.style.display = 'none';
            }
            
            // Rôle
            const modalRole = document.getElementById('modal-role');
            if (character.role) {
                modalRole.innerHTML = '<span class="role-name">' + character.role + '</span>';
                modalRole.style.display = 'flex';
            } else {
                modalRole.style.display = 'none';
            }
            
            modal.classList.add('active');
        });
    });

    // Fermer la modale
    modalClose.addEventListener('click', function() {
        modal.classList.remove('active');
    });

    // Fermer la modale en cliquant à l'extérieur
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });

    // Initialiser le compteur
    updateTeamCounter();
});
</script>

{% endblock %}
